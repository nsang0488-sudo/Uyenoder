<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UY√äN COFFEE POS</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #5d3fd3; --success: #28a745; --danger: #dc3545; --dark: #2c3e50; --bg: #f4f7f6; --warning: #ffc107; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; }

        /* Navbar */
        .navbar { background: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .nav-links { display: flex; gap: 5px; }
        .nav-item { padding: 8px 10px; cursor: pointer; border-radius: 5px; font-size: 12px; font-weight: bold; color: #666; background: #f0f0f0; border: none; }
        .nav-item.active { background: var(--primary); color: white; }

        /* Layout Content */
        .tab-content { display: none; flex: 1; overflow: hidden; position: relative; width: 100%; }
        .tab-content.active { display: flex; }

        /* Desktop: 3 c·ªôt */
        .tables-col { width: 35%; display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; padding: 10px; overflow-y: auto; background: #e2e8f0; border-right: 1px solid #ccc; }
        .menu-col { width: 35%; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; overflow-y: auto; background: #f8f9fa; border-right: 1px solid #ccc; }
        .bill-col { width: 30%; display: flex; flex-direction: column; background: white; }

        /* Mobile: Ch·∫ø ƒë·ªô 1 c·ªôt */
        @media (max-width: 768px) {
            .tables-col, .menu-col, .bill-col { position: absolute; width: 100%; height: 100%; display: none !important; }
            .tab-content.active .active-mob { display: grid !important; }
            .tab-content.active .bill-col.active-mob { display: flex !important; }
           .mobile-bottom-nav { 
    display: flex !important; 
    position: fixed; 
    bottom: 60px; /* ƒê·∫©y l√™n cao ƒë·ªÉ n√© qu·∫£ng c√°o */
    left: 0; 
    width: 100%; 
    z-index: 9999; 
}
        }

       .mobile-bottom-nav { 
    display: none; 
    background: white; 
    border-top: 1px solid #ddd; 
    height: 60px; 
    justify-content: space-around; 
    align-items: center; 
    flex-shrink: 0;
    position: fixed; /* Th√™m d√≤ng n√†y n·∫øu ch∆∞a c√≥ */
    bottom: 60px;    /* ƒê·ªïi t·ª´ 0 th√†nh 60 */
    width: 100%;
}
        .m-btn { flex: 1; text-align: center; font-size: 11px; color: #888; cursor: pointer; }
        .m-btn.active { color: var(--primary); font-weight: bold; }

        /* UI Components */
        .table-card { background: white; height: 60px; border: 2px solid #cbd5e0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; font-size: 11px; text-align: center; }
        .status-white { background: white; }
        .status-red { background: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .status-green { background: #dcfce7; border-color: #22c55e; color: #166534; }
        .table-card.selected { border: 4px solid var(--warning); }

        .menu-item { background: white; border: 1px solid #ddd; padding: 15px 5px; border-radius: 8px; text-align: center; cursor: pointer; font-weight: 600; font-size: 13px; }
        .bill-header { padding: 10px; background: var(--dark); color: white; display: flex; justify-content: space-between; align-items: center; }
        .bill-body { flex: 1; overflow-y: auto; padding: 8px; }
        .bill-row { padding: 8px 0; border-bottom: 1px dashed #eee; cursor: pointer; }

        /* Modals */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; padding: 10px; }
        .modal { background: white; width: 100%; max-width: 350px; border-radius: 12px; padding: 15px; }
        .opt-btn { padding: 12px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .opt-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    </style>
</head>
<body>

<div class="navbar">
    <div style="font-weight: 900; color: var(--primary); font-size: 16px;">UY√äN COFFEE</div>
    <div class="nav-links">
        <button class="nav-item active" onclick="showTab('pos')">B√°n H√†ng</button>
        <button class="nav-item" onclick="showTab('edit-menu')">S·ª≠a Menu</button>
        <button class="nav-item" onclick="showTab('shift')">Ca & LS</button>
    </div>
</div>

<div id="tab-pos" class="tab-content active">
    <div id="col-tables" class="tables-col active-mob"></div>
    <div id="col-menu" class="menu-col"></div>
    <div id="col-bill" class="bill-col">
        <div class="bill-header"><b id="activeTableLabel">B√ÄN?</b> <button onclick="moveTable()" style="font-size:10px;">ƒê·ªïi</button></div>
        <div id="billContent" class="bill-body"></div>
        <div style="padding:10px; border-top:1px solid #ddd;">
            <div style="display:flex; justify-content:space-between; font-weight:bold; color:var(--danger); margin-bottom:10px;">
                T·ªîNG: <span id="totalDisplay">0</span>ƒë
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <button onclick="confirmPrint()" style="background:var(--primary); color:white; border:none; padding:10px; border-radius:5px; font-weight:bold;">X√ÅC NH·∫¨N</button>
                <button onclick="setDone()" style="background:var(--success); color:white; border:none; padding:10px; border-radius:5px; font-weight:bold;">XONG</button>
            </div>
            <button onclick="openPay()" style="background:var(--dark); color:white; border:none; width:100%; padding:12px; border-radius:5px; margin-top:5px; font-weight:bold;">THANH TO√ÅN</button>
        </div>
    </div>
</div>

<div id="tab-edit-menu" class="tab-content">
    <div style="padding: 15px; width: 100%; overflow-y: auto;">
        <h3>S·ª≠a th·ª±c ƒë∆°n</h3>
        <input id="inMenuName" type="text" placeholder="T√™n m√≥n" style="width:100%; padding:10px; margin-bottom:5px;">
        <input id="inMenuPrice" type="number" placeholder="Gi√°" style="width:100%; padding:10px; margin-bottom:10px;">
        <button onclick="addMenu()" style="width:100%; background:var(--success); color:white; border:none; padding:10px; border-radius:5px;">TH√äM M·ªöI</button>
        <hr>
        <div id="listMenuAdmin"></div>
    </div>
</div>

<div id="tab-shift" class="tab-content">
    <div style="padding: 15px; width: 100%; overflow-y: auto;">
        <h3>B√°o c√°o ca</h3>
        <div id="shiftInfo" style="background:#fff; padding:10px; border-radius:8px; border:1px solid #ddd;"></div>
        <button id="btnOpenShift" onclick="startShift()" style="width:100%; background:var(--success); color:white; border:none; padding:10px; margin-top:10px; border-radius:5px;">M·ªû CA</button>
        <button id="btnCloseShift" onclick="endShift()" style="width:100%; background:var(--danger); color:white; border:none; padding:10px; margin-top:10px; border-radius:5px;">CH·ªêT CA</button>
        <div id="historyList" style="margin-top:20px;"></div>
    </div>
</div>

<div id="pos-mob-nav" class="mobile-bottom-nav">
    <div class="m-btn active" id="m-btn-tables" onclick="switchMob('tables')">ü™ë B√†n</div>
    <div class="m-btn" id="m-btn-menu" onclick="switchMob('menu')">‚òï Menu</div>
    <div class="m-btn" id="m-btn-bill" onclick="switchMob('bill')">üßæ ƒê∆°n</div>
</div>

<div id="optionModal" class="modal-overlay">
    <div class="modal">
        <h3 id="optItemName">T√™n m√≥n</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
            <button id="btnNong" class="opt-btn" onclick="selType('N√≥ng')">N√ìNG</button>
            <button id="btnDa" class="opt-btn" onclick="selType('ƒê√°')">ƒê√Å</button>
        </div>
        <input id="optNote" type="text" placeholder="Ghi ch√∫ (vd: √≠t ƒë∆∞·ªùng...)" style="width:100%; padding:12px; border-radius:5px; border:1px solid #ddd; margin-bottom:15px;">
        <button onclick="addToBillFinal()" style="width:100%; background:var(--primary); color:white; border:none; padding:12px; border-radius:8px; font-weight:bold;">X√ÅC NH·∫¨N TH√äM</button>
        <p onclick="closeModal('optionModal')" style="text-align:center; color:gray; cursor:pointer; margin-top:10px;">H·ªßy</p>
    </div>
</div>

<div id="editQtyModal" class="modal-overlay">
    <div class="modal">
        <h3 id="editItemName">S·ª≠a m√≥n</h3>
        <div style="display:flex; justify-content:center; align-items:center; gap:30px; margin:20px 0;">
            <button onclick="changeQty(-1)" style="width:50px; height:50px; font-size:24px;">-</button>
            <b id="editQtyVal" style="font-size:24px;">1</b>
            <button onclick="changeQty(1)" style="width:50px; height:50px; font-size:24px;">+</button>
        </div>
        <button onclick="removeItem()" style="width:100%; background:var(--danger); color:white; border:none; padding:12px; border-radius:5px; margin-bottom:10px;">X√ìA M√ìN</button>
        <button onclick="saveQty()" style="width:100%; background:var(--success); color:white; border:none; padding:12px; border-radius:5px;">L∆ØU</button>
    </div>
</div>

<script>
    // FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyCY23UN98357R178ZCxY9BhoTiX3LTzaQ8",
        authDomain: "uyencoffeepos.firebaseapp.com",
        databaseURL: "https://uyencoffeepos-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "uyencoffeepos",
        storageBucket: "uyencoffeepos.firebasestorage.app",
        messagingSenderId: "320504505998",
        appId: "1:320504505998:web:267ba0c6e8a283b4dd8bdf"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let curTable = null, tablesData = {}, menuData = {}, currentShift = null, editingIdx = null;
    let tempItem = null, selectedType = 'ƒê√°';

    // Realtime Sync
    db.ref('menu').on('value', s => { menuData = s.val() || {}; renderMenu(); renderMenuAdmin(); });
    db.ref('tables').on('value', s => { tablesData = s.val() || {}; renderTables(); if(curTable) renderBill(); });
    db.ref('active_shift').on('value', s => { currentShift = s.val(); updateShiftUI(); });

    // Tabs & Mobile Logic
    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('tab-'+id).classList.add('active');
        event.target.classList.add('active');
        document.getElementById('pos-mob-nav').style.display = (id === 'pos' ? 'flex' : 'none');
    }

    function switchMob(col) {
        document.querySelectorAll('.tables-col, .menu-col, .bill-col').forEach(c => c.classList.remove('active-mob'));
        document.querySelectorAll('.m-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('col-'+col).classList.add('active-mob');
        document.getElementById('m-btn-'+col).classList.add('active');
    }

    // POS Core
    function renderTables() {
        const g = document.getElementById('col-tables'); g.innerHTML = '';
        for(let i=1; i<=40; i++) {
            const d = tablesData[i] || {status:'white'};
            g.innerHTML += `<div class="table-card status-${d.status} ${curTable==i?'selected':''}" onclick="selectTable(${i})">B√ÄN ${i}</div>`;
        }
    }

    function selectTable(i) { 
        curTable = i; document.getElementById('activeTableLabel').innerText = "B√ÄN " + i; 
        renderTables(); renderBill(); if(window.innerWidth <= 768) switchMob('menu');
    }

    function renderMenu() {
        const c = document.getElementById('col-menu'); c.innerHTML = '';
        Object.keys(menuData).forEach(k => {
            const m = menuData[k];
            c.innerHTML += `<div class="menu-item" onclick="openOption('${m.name}', ${m.price})">${m.name}<br>${m.price.toLocaleString()}ƒë</div>`;
        });
    }

    // N√≥ng ƒê√° & Ghi Ch√∫
    function openOption(name, price) {
        if(!currentShift) return alert("Ch∆∞a m·ªü ca!");
        if(!curTable) return alert("Ch∆∞a ch·ªçn b√†n!");
        tempItem = { name, price };
        selectedType = 'ƒê√°';
        document.getElementById('optItemName').innerText = name;
        document.getElementById('optNote').value = '';
        selType('ƒê√°');
        document.getElementById('optionModal').style.display = 'flex';
    }

    function selType(t) {
        selectedType = t;
        document.getElementById('btnNong').className = (t=='N√≥ng'?'opt-btn active':'opt-btn');
        document.getElementById('btnDa').className = (t=='ƒê√°'?'opt-btn active':'opt-btn');
    }

    function addToBillFinal() {
        let note = document.getElementById('optNote').value;
        let items = tablesData[curTable]?.items || [];
        let fullName = `${tempItem.name} (${selectedType})${note?': '+note:''}`;
        
        let ex = items.find(i => i.fullName === fullName);
        if(ex) ex.qty++; else items.push({fullName, price: tempItem.price, qty: 1});
        
        db.ref('tables/'+curTable).update({items, status: tablesData[curTable]?.status || 'white'});
        closeModal('optionModal');
        if(window.innerWidth <= 768) switchMob('bill');
    }

    function renderBill() {
        const b = document.getElementById('billContent'); b.innerHTML = '';
        let total = 0; const items = tablesData[curTable]?.items || [];
        items.forEach((it, idx) => {
            total += (it.price * it.qty);
            b.innerHTML += `<div class="bill-row" onclick="openEdit(${idx})">
                <div style="font-size:13px;"><b>${it.qty}x</b> ${it.fullName}</div>
                <div style="color:blue">${(it.price*it.qty).toLocaleString()}</div>
            </div>`;
        });
        document.getElementById('totalDisplay').innerText = total.toLocaleString();
    }

    // Edit Menu & Shift (Gi·ªØ nguy√™n logic b·∫°n mu·ªën)
    function addMenu() {
        const name = document.getElementById('inMenuName').value;
        const price = parseInt(document.getElementById('inMenuPrice').value);
        if(name && price) { db.ref('menu').push({name, price}); document.getElementById('inMenuName').value=''; document.getElementById('inMenuPrice').value=''; }
    }

    function renderMenuAdmin() {
        const d = document.getElementById('listMenuAdmin'); d.innerHTML = '';
        Object.keys(menuData).forEach(k => {
            d.innerHTML += `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;">
                <span>${menuData[k].name} (${menuData[k].price}ƒë)</span>
                <button onclick="db.ref('menu/${k}').remove()" style="background:red; color:white; border:none; border-radius:3px;">X√≥a</button>
            </div>`;
        });
    }

    function updateShiftUI() {
        const info = document.getElementById('shiftInfo');
        if(currentShift) {
            info.innerHTML = `Ca m·ªü: ${currentShift.start}<br>Ti·ªÅn: <b>${(currentShift.revenue||0).toLocaleString()}ƒë</b>`;
            document.getElementById('btnOpenShift').style.display = 'none';
            document.getElementById('btnCloseShift').style.display = 'block';
        } else {
            info.innerText = "ƒêang ƒë√≥ng ca";
            document.getElementById('btnOpenShift').style.display = 'block';
            document.getElementById('btnCloseShift').style.display = 'none';
        }
    }

    function startShift() { db.ref('active_shift').set({start: new Date().toLocaleString('vi-VN'), revenue: 0}); }
    function endShift() { if(confirm("ƒê√≥ng ca?")) { db.ref('active_shift').remove(); db.ref('tables').remove(); } }

    // Helpers
    function openEdit(idx) { editingIdx = idx; const it = tablesData[curTable].items[idx]; document.getElementById('editItemName').innerText = it.fullName; document.getElementById('editQtyVal').innerText = it.qty; document.getElementById('editQtyModal').style.display='flex'; }
    function changeQty(v) { let q = parseInt(document.getElementById('editQtyVal').innerText); if(q+v>=1) document.getElementById('editQtyVal').innerText = q+v; }
    function saveQty() { let items = tablesData[curTable].items; items[editingIdx].qty = parseInt(document.getElementById('editQtyVal').innerText); db.ref('tables/'+curTable+'/items').set(items); closeModal('editQtyModal'); }
    function removeItem() { let items = tablesData[curTable].items; items.splice(editingIdx,1); db.ref('tables/'+curTable+'/items').set(items); closeModal('editQtyModal'); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function setDone() { if(curTable) db.ref('tables/'+curTable+'/status').set('green'); }
    function openPay() {
        const total = parseInt(document.getElementById('totalDisplay').innerText.replace(/\./g,''));
        if(total > 0 && confirm("Thanh to√°n?")) {
            db.ref('active_shift/revenue').set((currentShift.revenue||0) + total);
            db.ref('tables/'+curTable).remove(); curTable = null; renderTables(); renderBill();
            if(window.innerWidth <= 768) switchMob('tables');
        }
    }
    function confirmPrint() { if(curTable) db.ref('tables/'+curTable+'/status').set('red'); window.print(); }
    function moveTable() { let to = prompt("S·ªë b√†n m·ªõi:"); if(to && tablesData[curTable]) { db.ref('tables/'+to).set(tablesData[curTable]); db.ref('tables/'+curTable).remove(); selectTable(to); } }
</script>
</body>
</html>